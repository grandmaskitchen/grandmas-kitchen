<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grandma‚Äôs Pantry ‚Ä¢ Shop</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Optional: tiny skeleton while loading */
    .skeleton{background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton.img{width:200px;height:200px;border-radius:12px;margin:0 auto 10px}
    .skeleton.text{height:16px;border-radius:8px;margin:6px 0}
    .cat-link{ text-decoration:none; }
    .cat-link:hover{ text-decoration:underline; }
  </style>
</head>
<body>

<header class="container center">
  <a href="/index.html">
    <img src="/images/logo.jpg" alt="Grandma‚Äôs Kitchen Logo" style="max-height:100px;margin-bottom:1rem;">
  </a>
  <nav aria-label="Primary">
    <a href="/index.html">Home</a>
    <a href="/about.html">About</a>
    <a href="/recipes.html">Recipes</a>
    <a href="/shop.html" aria-current="page">Shop</a>
  </nav>
  <p class="lead">Staples we actually use at home‚Äîsimple, honest ingredients.</p>
</header>

<main>
  <div class="container container--narrow">
    <h1>üõí Grandma‚Äôs Pantry</h1>
    <p id="catNotice" class="muted" style="display:none;margin-top:.25rem"></p>
  </div>

  <div class="container">
    <div id="grid" class="grid grid-2">
      <!-- Skeleton placeholders shown first -->
      <article class="card">
        <div class="skeleton img"></div>
        <div class="skeleton text" style="width:60%"></div>
        <div class="skeleton text" style="width:90%"></div>
        <div class="skeleton text" style="width:40%"></div>
      </article>
      <article class="card">
        <div class="skeleton img"></div>
        <div class="skeleton text" style="width:70%"></div>
        <div class="skeleton text" style="width:85%"></div>
        <div class="skeleton text" style="width:45%"></div>
      </article>
    </div>
  </div>
</main>

<footer class="container container--narrow">
  <p>¬© 2025 Grandma‚Äôs Kitchen ‚Ä¢ All rights reserved</p>
  <p class="affiliate-note">As an Amazon Associate, we (Grandma's Kitchen) earn from qualifying purchases.</p>
</footer>

<script>
(async function () {
  const grid = document.getElementById('grid');
  const catNotice = document.getElementById('catNotice');
  const esc = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const params = new URLSearchParams(location.search);
  const catParam = (params.get('cat') || '').trim();

  try {
    const r = await fetch('/api/shop-list?limit=100', { cache: 'no-store' });
    const json = await r.json();
    const items = Array.isArray(json.items) ? json.items : (Array.isArray(json.products) ? json.products : []);
    if (!r.ok) throw new Error(json?.error || 'Failed to load');

    // Optional: client-side category filter by exact name (case-insensitive)
    let list = items;
    if (catParam) {
      const needle = catParam.toLowerCase();
      list = items.filter(p => (p.amazon_category || '').toLowerCase() === needle);
      // Show notice + clear link
      catNotice.style.display = 'block';
      catNotice.innerHTML = `Showing category: <strong>${esc(catParam)}</strong> ‚Ä¢ <a href="/shop.html">Clear filter</a>`;
    }

    if (!list.length) {
      grid.innerHTML = catParam
        ? `<p class="muted">No products in ‚Äú${esc(catParam)}‚Äù. <a href="/shop.html">Clear filter</a></p>`
        : `<p class="muted">No products yet.</p>`;
      return;
    }

    grid.innerHTML = list.map(p => {
      const title = p.my_title || p.amazon_title || 'Product';
      const img = p.image_main || '';
      const slug = p.product_num || '';
      const cat  = p.amazon_category || '';
      const href = `/products/${encodeURIComponent(slug)}`;
      return `
        <article class="card" aria-labelledby="prod-${esc(slug)}-title">
          <a class="product-image" href="${href}">
            ${img ? `<img loading="lazy" decoding="async" src="${esc(img)}" alt="${esc(title)}">` : ''}
          </a>
          <h3 id="prod-${esc(slug)}-title" class="product-title">
            <a href="${href}">${esc(title)}</a>
          </h3>
          ${cat ? `<p class="muted" style="margin:.25rem 0 .5rem;font-size:.95rem">
                     <a class="cat-link" href="/shop.html?cat=${encodeURIComponent(cat)}">${esc(cat)}</a>
                   </p>` : ''}
          <p><a class="btn" href="${href}">View product</a></p>
        </article>
      `;
    }).join('');
  } catch (err) {
    console.error(err);
    grid.innerHTML = `<p class="muted">Sorry, the shop is unavailable right now.</p>`;
  }
})();
</script>
</body>
</html>
