<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grandmaâ€™s Pantry â€¢ Shop</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .skeleton{background:linear-gradient(90deg,#eee 25%,#f5f5f5 37%,#eee 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .skeleton.img{width:200px;height:200px;border-radius:12px;margin:0 auto 10px}
    .skeleton.text{height:16px;border-radius:8px;margin:6px 0}
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#eef3ee;color:#2f5130;text-decoration:none;font-size:.8rem}
    .line-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body>

<header class="container center">
  <a href="/index.html">
    <img class="site-logo" src="/images/logo.jpg" alt="Grandmaâ€™s Kitchen Logo">
  </a>
  <nav aria-label="Primary">
    <a href="/index.html">Home</a>
    <a href="/about.html">About</a>
    <a href="/recipes.html">Recipes</a>
    <a href="/shop.html" aria-current="page">Shop</a>
  </nav>
  <p class="lead">Staples we actually use at homeâ€”simple, honest ingredients.</p>
</header>

<main>
  <div class="container container--narrow">
    <h1>ðŸ›’ Grandmaâ€™s Pantry</h1>
    <p id="catNote" class="muted" style="margin-top:-.5rem"></p>
  </div>

  <div class="container">
    <div id="grid" class="grid grid-2">
      <!-- skeletons -->
      <article class="card"><div class="skeleton img"></div><div class="skeleton text" style="width:60%"></div><div class="skeleton text" style="width:90%"></div></article>
      <article class="card"><div class="skeleton img"></div><div class="skeleton text" style="width:70%"></div><div class="skeleton text" style="width:85%"></div></article>
    </div>
  </div>
</main>

<footer class="container container--narrow">
  <p>Â© 2025 Grandmaâ€™s Kitchen â€¢ All rights reserved</p>
  <p class="affiliate-note">As an Amazon Associate, we (Grandma's Kitchen) earn from qualifying purchases.</p>
</footer>

<script>
(async function () {
  const grid = document.getElementById('grid');
  const catNote = document.getElementById('catNote');
  const esc = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const qs = new URLSearchParams(location.search);
  const cat = (qs.get('cat') || '').trim();    // <-- single param: ?cat=

  if (cat) {
    catNote.innerHTML = `Filtering by category: <a class="chip" href="/shop.html?cat=${encodeURIComponent(cat)}">${esc(cat)}</a> &nbsp; <a href="/shop.html" class="muted">(clear)</a>`;
  }

  try {
    const url = new URL('/api/shop-list', location.origin);
    url.searchParams.set('limit', '100');
    if (cat) url.searchParams.set('cat', cat);

    const r = await fetch(url.toString(), { cache: 'no-store' });
    const { items, error } = await r.json();
    if (!r.ok || !Array.isArray(items)) throw new Error(error || 'Failed to load');

    if (!items.length) {
      grid.innerHTML = `<p class="muted">No products found.</p>`;
      return;
    }

    grid.innerHTML = items.map(p => {
      const title = p.my_title || p.amazon_title || 'Product';
      const img = p.image_main || '';
      const slug = p.product_num || '';
      const c = p.amazon_category || '';

      return `
        <article class="card" aria-labelledby="prod-${esc(slug)}-title">
          <a class="product-image" href="/products/${encodeURIComponent(slug)}">
            ${img ? `<img loading="lazy" decoding="async" src="${esc(img)}" alt="${esc(title)}">` : ''}
          </a>
          <h3 id="prod-${esc(slug)}-title" class="product-title line-2">
            <a href="/products/${encodeURIComponent(slug)}">${esc(title)}</a>
          </h3>
          ${c ? `<p class="muted" style="margin:.25rem 0 .5rem">
              <a class="chip" href="/shop.html?cat=${encodeURIComponent(c)}">${esc(c)}</a>
            </p>` : ''}
          <p><a class="btn" href="/products/${encodeURIComponent(slug)}">View product</a></p>
        </article>
      `;
    }).join('');
  } catch (err) {
    console.error(err);
    grid.innerHTML = `<p class="muted">Sorry, the shop is unavailable right now.</p>`;
  }
})();
</script>
  <script>
(async function adminOverlay(){
  const admin = new URLSearchParams(location.search).get('admin') === '1';
  if (!admin) return;

  // After the grid has been rendered by your existing code, add delete buttons
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
  for (let i=0;i<20;i++){ // wait up to ~2s for grid population
    await wait(100);
    if ([...document.querySelectorAll('#grid article')].length) break;
  }

  document.querySelectorAll('#grid article').forEach(card => {
    const link = card.querySelector('a[href^="/products/"]');
    if (!link) return;
    const slug = decodeURIComponent(link.getAttribute('href').split('/').pop());
    const btn = document.createElement('button');
    btn.textContent = 'ðŸ—‘';
    btn.title = `Delete ${slug}`;
    btn.style.cssText = 'position:absolute;top:6px;right:6px;background:#b33;color:#fff;border:0;border-radius:6px;padding:4px 6px;cursor:pointer';
    btn.addEventListener('click', async () => {
      if (!confirm(`Delete product ${slug}?`)) return;
      const r = await fetch(`/api/admin/products/${encodeURIComponent(slug)}`, { method:'DELETE', credentials:'include' });
      const j = await r.json();
      if (!r.ok) return alert(j?.error||'Delete failed');
      card.remove();
    });
    card.style.position = 'relative';
    card.appendChild(btn);
  });
})();
    <style>
  /* admin-only affordances */
  article.card { position: relative; }
  .admin-archive {
    position:absolute; top:6px; right:6px;
    background:#b33; color:#fff; border:0; border-radius:8px;
    padding:4px 8px; cursor:pointer; font-size:.9rem;
    box-shadow:0 1px 4px rgba(0,0,0,.15);
  }
  .broken img { opacity:.6; }
  article.card.broken { outline: 2px dashed #b33; }
</style>
<script>
(async function adminOverlay(){
  // Only show when explicitly requested (and you're authenticated behind Access).
  const admin = new URLSearchParams(location.search).get('admin') === '1';
  if (!admin) return;

  // Wait for grid to populate (your existing JS does this async)
  const wait = ms => new Promise(r => setTimeout(r, ms));
  for (let i=0;i<30;i++){ await wait(100); if (document.querySelector('#grid article')) break; }

  function getSlugFromCard(card){
    const a = card.querySelector('a.product-image');
    if (!a) return null;
    const href = a.getAttribute('href') || '';
    return decodeURIComponent(href.split('/').pop() || '');
  }

  // Add archive button to each card
  document.querySelectorAll('#grid article.card').forEach(card => {
    const slug = getSlugFromCard(card);
    if (!slug) return;

    // Mark card broken if image fails
    const img = card.querySelector('.product-image img');
    if (img) {
      img.addEventListener('error', () => {
        card.classList.add('broken');
      }, { once:true });
    }

    const btn = document.createElement('button');
    btn.className = 'admin-archive';
    btn.textContent = 'Archive';
    btn.title = `Hide this product (${slug}) from site`;
    btn.addEventListener('click', async () => {
      if (!confirm(`Archive product ${slug} now?\n(It will be hidden from Shop & Home Picks but can be restored later.)`)) return;
      const r = await fetch(`/api/admin/products/${encodeURIComponent(slug)}/archive`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ reason: 'archived from shop overlay' })
      });
      const j = await r.json();
      if (!r.ok) { alert(j?.error || 'Archive failed'); return; }
      card.remove();
    });
    card.appendChild(btn);
  });
})();
</script>

</script>

</body>
</html>
