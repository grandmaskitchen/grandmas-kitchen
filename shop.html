<script>
(async function () {
  const grid = document.getElementById('grid');
  const esc = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));

  try {
    // New endpoint (approved products). Works with multiple shapes.
    const res  = await fetch('/api/products-list?approved=true', { headers: { 'Accept': 'application/json' } });
    const data = await res.json();

    // Accept: [{...}] OR {products:[...]} OR {items:[...]}
    const rows = Array.isArray(data) ? data : (data.products || data.items || []);
    if (!Array.isArray(rows)) throw new Error('Unexpected response');

    // Client-side dedupe (newest wins) by product_num (case-insensitive)
    const seen = new Set();
    const products = [];
    for (const p of rows) {
      const key = (p.product_num || '').toLowerCase();
      if (key) {
        if (seen.has(key)) continue;
        seen.add(key);
      }
      products.push(p);
    }

    if (!products.length) {
      grid.innerHTML = `<p class="muted">No products yet.</p>`;
      return;
    }

    grid.innerHTML = products.map(p => {
      const title = p.my_title || p.amazon_title || 'Product';
      const img   = p.image_main || '';
      const slug  = (p.product_num || '').toString();
      const cat   = p.amazon_category || '';

      // Prefer your affiliate link if present; otherwise fall back to a local page
      const href       = (p.affiliate_link || '').trim() || `/products/${encodeURIComponent(slug)}`;
      const isAmazon   = /amzn\.to|amazon\./i.test(href);
      const relAttrs   = isAmazon ? 'rel="nofollow sponsored noopener"' : '';
      const targetAttr = isAmazon ? 'target="_blank"' : '';
      const ctaLabel   = isAmazon ? 'View on Amazon' : 'View product';

      return `
        <article class="card" aria-labelledby="prod-${esc(slug || title)}-title">
          <a class="product-image" href="${esc(href)}" ${relAttrs} ${targetAttr}>
            ${img ? `<img loading="lazy" decoding="async" src="${esc(img)}" alt="${esc(title)}">` : ''}
          </a>
          <h3 id="prod-${esc(slug || title)}-title" class="product-title">
            <a href="${esc(href)}" ${relAttrs} ${targetAttr}>${esc(title)}</a>
          </h3>
          ${cat ? `<p class="muted" style="margin:.25rem 0 .5rem">${esc(cat)}</p>` : ''}
          <p><a class="btn" href="${esc(href)}" ${relAttrs} ${targetAttr}>${ctaLabel}</a></p>
        </article>
      `;
    }).join('');
  } catch (err) {
    console.error('Shop render failed:', err);
    grid.innerHTML = `<p class="muted">Sorry, the shop is unavailable right now.</p>`;
  }
})();
</script>
