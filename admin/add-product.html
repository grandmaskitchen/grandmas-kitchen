<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Product ‚Ä¢ Grandma‚Äôs Kitchen (Admin)</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fffdf8;color:#222;margin:0;padding:24px}
    .wrap{max-width:760px;margin:0 auto}
    h1{font-size:1.6rem;margin:0 0 1rem}
    form{display:grid;gap:12px;background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    label{font-weight:600}
    input,select,textarea{width:100%;box-sizing:border-box;padding:.6rem;border:1px solid #cfcfcf;border-radius:8px;font-size:1rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:12px;align-items:center;margin-top:.5rem}
    .hint{font-size:.85rem;color:#666}
    button{background:#44633F;color:#fff;border:0;border-radius:8px;padding:.7rem 1rem;cursor:pointer}
    button.secondary{background:#ddd;color:#222}
    #fetchStatus{font-size:.9rem;color:#666}
    #preview{display:none;background:#fff7ea;border:1px solid #eee;border-radius:10px;padding:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üì¶ Add a New Product</h1>

    <form id="productForm" autocomplete="off">
      <!-- Required -->
      <label for="my_title">My Title *</label>
      <input id="my_title" name="my_title" required />

      <label for="image_main">Main Image URL *</label>
      <input id="image_main" name="image_main" type="url" required placeholder="https://..." />

      <!-- Amazon / Affiliate -->
      <label for="affiliate_link">Affiliate Link (Amazon)</label>
      <div class="row" style="grid-template-columns:1fr auto">
        <input id="affiliate_link" name="affiliate_link" type="url" placeholder="https://amzn.to/... or https://www.amazon.co.uk/..." />
        <button id="fetchAmazon" type="button" title="Fetch details from Amazon">Fetch</button>
      </div>
      <span id="fetchStatus" class="hint"></span>

      <!-- Optional Amazon-origin fields -->
      <label for="amazon_title">Amazon Title</label>
      <input id="amazon_title" name="amazon_title" />

      <label for="amazon_desc">Amazon Description</label>
      <textarea id="amazon_desc" name="amazon_desc" rows="3"></textarea>

      <!-- Your content -->
      <label for="my_subtitle">My Subtitle</label>
      <input id="my_subtitle" name="my_subtitle" />

      <label for="my_description_short">Short Description</label>
      <textarea id="my_description_short" name="my_description_short" rows="2"></textarea>

      <label for="my_description_long">Long Description</label>
      <textarea id="my_description_long" name="my_description_long" rows="5"></textarea>

      <!-- FAB -->
      <label for="features">Features <span class="hint">(one per line)</span></label>
      <textarea id="features" name="features" rows="4" placeholder="‚Ä¢ Raw & unfiltered with 'the Mother'&#10;‚Ä¢ Vegan & non-GMO"></textarea>

      <label for="advantages">Advantages</label>
      <textarea id="advantages" name="advantages" rows="3" placeholder="Convenient capsules‚Äîno strong taste."></textarea>

      <label for="benefits">Benefits</label>
      <textarea id="benefits" name="benefits" rows="3" placeholder="Supports everyday digestion and wellness."></textarea>

      <!-- Images -->
      <div class="row">
        <div>
          <label for="image_small">Small Image URL</label>
          <input id="image_small" name="image_small" type="url" />
        </div>
        <div>
          <label for="image_extra_1">Extra Image 1 URL</label>
          <input id="image_extra_1" name="image_extra_1" type="url" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="image_extra_2">Extra Image 2 URL</label>
          <input id="image_extra_2" name="image_extra_2" type="url" />
        </div>
        <div>
          <label for="amazon_category">Amazon Category</label>
          <input id="amazon_category" name="amazon_category" />
        </div>
      </div>

      <!-- Meta -->
      <div class="row">
        <div>
          <label for="where_advertised">Where Advertised</label>
          <input id="where_advertised" name="where_advertised" placeholder="Instagram, Facebook" />
        </div>
        <div>
          <label for="ad_type">Ad Type</label>
          <select id="ad_type" name="ad_type">
            <option value="">‚Äî</option>
            <option value="organic">Organic</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="product_type">Product Type</label>
          <select id="product_type" name="product_type">
            <option value="">‚Äî</option>
            <option value="powder">Powder</option>
            <option value="tablet">Tablet</option>
            <option value="pill">Pill</option>
            <option value="liquid">Liquid</option>
          </select>
        </div>
        <div>
          <label for="commission_l">Commission %</label>
          <input id="commission_l" name="commission_l" type="number" step="0.01" placeholder="e.g. 2" />
        </div>
      </div>

      <!-- Optional -->
      <label for="added_by">Added By</label>
      <input id="added_by" name="added_by" />

      <label for="manufacturer">Manufacturer</label>
      <input id="manufacturer" name="manufacturer" />

      <label for="product_num">My Product #</label>
      <input id="product_num" name="product_num" />

      <div class="actions">
        <label style="display:flex;gap:.5rem;align-items:center;">
          <input type="checkbox" id="approved" name="approved" value="true" />
          Approved
        </label>
      </div>

      <div class="actions">
        <button type="submit">Submit</button>
        <a class="secondary" href="/shop.html"><button type="button" class="secondary">Back to Pantry</button></a>
      </div>
    </form>

    <div id="preview" class="wrap"></div>
  </div>

  <!-- Amazon fetch wiring -->
  <script>
    (function () {
      const btn = document.getElementById('fetchAmazon');
      const statusEl = document.getElementById('fetchStatus');
      const byName = (n) => document.querySelector(`[name="${n}"]`);

      async function doFetch() {
        const inputEl = document.getElementById('affiliate_link');
        let input = (inputEl?.value || '').trim();
        if (!input) {
          input = prompt('Paste an Amazon URL or ASIN:') || '';
          input = input.trim();
          if (!input) return;
          if (inputEl) inputEl.value = input;
        }

        statusEl.textContent = 'Fetching product details‚Ä¶';
        btn.disabled = true;
        try {
          // ---- Fallback: try both endpoints ----
          const endpoints = ['/api/amazon-fetch', '/api/admin/amazon-fetch'];
          let r, lastErr;

          for (const ep of endpoints) {
            try {
              r = await fetch(ep, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ input })
              });
              if (r.ok) break;                // success on this endpoint
              lastErr = new Error(`${ep} ‚Üí HTTP ${r.status}`);
            } catch (e) {
              lastErr = e;
            }
          }
          if (!r || !r.ok) throw lastErr || new Error('Fetch failed');

          const json = await r.json();
          // --------------------------------------

          const s = json.scraped || {};
          const setIfEmpty = (name, val) => {
            if (!val) return;
            const el = byName(name);
            if (el && !el.value) el.value = val;
          };

          setIfEmpty('amazon_title', s.amazon_title);
          setIfEmpty('amazon_desc',  s.amazon_desc);
          setIfEmpty('image_main',   s.image_main);
          setIfEmpty('image_small',  s.image_small || s.image_main);
          setIfEmpty('image_extra_1', s.image_extra_1);
          setIfEmpty('image_extra_2', s.image_extra_2);
          setIfEmpty('amazon_category', s.amazon_category);

          setIfEmpty('my_title', s.amazon_title);
          const short = byName('my_description_short');
          if (short && !short.value && s.amazon_desc) short.value = s.amazon_desc.slice(0, 240);

          statusEl.textContent = 'Filled from Amazon. Review fields, then Submit.';
        } catch (err) {
          alert('Fetch failed: ' + err.message);
          statusEl.textContent = 'Fetch failed.';
        } finally {
          btn.disabled = false;
        }
      }
      btn?.addEventListener('click', doFetch);
    })();
  </script>

  <!-- Submit to /api/products -->
  <script>
    (function () {
      const form = document.getElementById('productForm');
      const preview = document.getElementById('preview');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());

        data.approved = !!fd.get('approved');
        if (data.commission_l !== '' && data.commission_l != null) {
          const n = Number(data.commission_l);
          data.commission_l = Number.isFinite(n) ? n : null;
        } else {
          data.commission_l = null;
        }

        const res = await fetch('/api/admin/product-upsert', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)
});

          const out = await res.json();
          if (!res.ok) {
            console.error(out);
            return alert((out && out.error) ? '‚ùå ' + out.error : '‚ùå Insert failed');
          }

          const row = out.product || data;
          preview.style.display = 'block';
          preview.innerHTML = `
            <h3>‚úÖ Product Preview</h3>
            <p><strong>${row.my_title || ''}</strong><br><em>${row.my_subtitle || ''}</em></p>
            ${row.image_main ? `<img src="${row.image_main}" alt="Preview" style="max-width:100%;border-radius:8px" />` : ''}
            <p>${row.my_description_short || ''}</p>
          `;
          form.reset();
          alert('‚úÖ Saved!');
        } catch (err) {
          console.error(err);
          alert('‚ùå Failed to add product.');
        }
      });
    })();
  </script>
</body>
</html>
